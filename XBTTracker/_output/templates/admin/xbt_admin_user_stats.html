<!-- admin:xbt_admin_user_stats -->
<xf:title>{{ phrase('xbt_user_stats') }}</xf:title>

<xf:pageaction>
    <xf:button href="{{ link('members/add') }}" icon="add" overlay="true">{{ phrase('add_user') }}</xf:button>
</xf:pageaction>

<div class="block">
    <div class="block-container">
        <div class="block-header">
            <h2 class="block-header-title">{{ phrase('search_users') }}</h2>
        </div>
        <div class="block-body">
            <xf:form action="{{ link('tracker/users') }}" class="block">
                <div class="block-filterBar">
                    <div class="filterBar">
                        <xf:textbox name="username" value="{{ $username }}" placeholder="{{ phrase('username') }}..." />
                        
                        <xf:select name="ratio" value="{{ $ratio }}">
                            <xf:option value="">{{ phrase('all_users') }}</xf:option>
                            <xf:option value="low">{{ phrase('xbt_low_ratio') }} (< 0.5)</xf:option>
                            <xf:option value="good">{{ phrase('xbt_good_ratio') }} (> 1.0)</xf:option>
                            <xf:option value="excellent">{{ phrase('xbt_excellent_ratio') }} (> 2.0)</xf:option>
                        </xf:select>
                        
                        <xf:select name="sort" value="{{ $sort }}">
                            <xf:option value="username">{{ phrase('username') }}</xf:option>
                            <xf:option value="upload">{{ phrase('xbt_uploaded') }}</xf:option>
                            <xf:option value="download">{{ phrase('xbt_downloaded') }}</xf:option>
                            <xf:option value="ratio">{{ phrase('xbt_ratio') }}</xf:option>
                            <xf:option value="bonus">{{ phrase('xbt_bonus_points') }}</xf:option>
                            <xf:option value="active">{{ phrase('xbt_active_torrents') }}</xf:option>
                        </xf:select>
                        
                        <xf:select name="order" value="{{ $order }}">
                            <xf:option value="desc">{{ phrase('desc') }}</xf:option>
                            <xf:option value="asc">{{ phrase('asc') }}</xf:option>
                        </xf:select>
                        
                        <xf:button type="submit" icon="search">{{ phrase('filter') }}</xf:button>
                    </div>
                </div>
            </xf:form>
        </div>
    </div>
</div>

<div class="block">
    <div class="block-container">
        <div class="block-header">
            <h2 class="block-header-title">{{ phrase('xbt_user_stats') }}</h2>
            <div class="block-header-controls">
                <span class="block-header-control">
                    <span class="u-muted">
                        {{ phrase('showing_items_x_to_y_of_z', {
                            'start': ($page - 1) * $perPage + 1,
                            'end': $page * $perPage > $total ? $total : $page * $perPage,
                            'total': $total
                        }) }}
                    </span>
                </span>
            </div>
        </div>
        
        <div class="block-body">
            <xf:if is="$users is empty">
                <div class="block-row">{{ phrase('no_users_matching_criteria') }}</div>
            <xf:else />
                <div class="block-row">
                    <div class="dataList">
                        <div class="dataList-row dataList-row--header">
                            <div class="dataList-cell dataList-cell--user">{{ phrase('username') }}</div>
                            <div class="dataList-cell dataList-cell--main">
                                <div class="dataList-mainRow">{{ phrase('xbt_user_activity') }}</div>
                                <div class="dataList-subRow">
                                    <span class="dataList-hint">{{ phrase('xbt_uploaded') }}</span>
                                    <span class="dataList-hint">{{ phrase('xbt_downloaded') }}</span>
                                    <span class="dataList-hint">{{ phrase('xbt_ratio') }}</span>
                                </div>
                            </div>
                            <div class="dataList-cell dataList-cell--meta">
                                <div class="dataList-mainRow">{{ phrase('xbt_active_torrents') }}</div>
                            </div>
                            <div class="dataList-cell dataList-cell--meta">
                                <div class="dataList-mainRow">{{ phrase('xbt_bonus_points') }}</div>
                            </div>
                            <div class="dataList-cell dataList-cell--action">{{ phrase('actions') }}</div>
                        </div>
                        
                        <xf:foreach loop="$users" value="$user">
                            <div class="dataList-row">
                                <div class="dataList-cell dataList-cell--user">
                                    <xf:username user="$user" />
                                    <xf:if is="$user.xbt_passkey">
                                        <span class="label label--success" title="{{ phrase('xbt_has_passkey') }}">
                                            <i class="fa fa-key" aria-hidden="true"></i>
                                        </span>
                                    </xf:if>
                                </div>
                                <div class="dataList-cell dataList-cell--main">
                                    <div class="dataList-mainRow">
                                        <div class="progressBar">
                                            <xf:if is="$user.XBTUserStats.downloaded > 0 AND $user.XBTUserStats.uploaded > 0">
                                                <xf:set var="$ratioWidth" value="50" />
                                                
                                                <xf:if is="$user.XBTUserStats.ratio < 1">
                                                    <xf:set var="$ratioWidth" value="{{ $user.XBTUserStats.ratio * 50 }}" />
                                                </xf:if>
                                                
                                                <xf:if is="$user.XBTUserStats.ratio >= 2">
                                                    <xf:set var="$ratioWidth" value="100" />
                                                </xf:if>
                                                
                                                <div class="progressBar-progress" style="width: {{ $ratioWidth }}%"></div>
                                            <xf:elseif is="$user.XBTUserStats.uploaded > 0" />
                                                <div class="progressBar-progress" style="width: 100%"></div>
                                            <xf:else />
                                                <div class="progressBar-progress" style="width: 0%"></div>
                                            </xf:if>
                                        </div>
                                    </div>
                                    <div class="dataList-subRow">
                                        <span class="dataList-hint">{$user.XBTUserStats.uploaded|file_size}</span>
                                        <span class="dataList-hint">{$user.XBTUserStats.downloaded|file_size}</span>
                                        <xf:if is="$user.XBTUserStats.downloaded > 0">
                                            <xf:if is="$user.XBTUserStats.ratio >= 1">
                                                <span class="dataList-hint dataList-hint--good">{$user.XBTUserStats.ratio|number(2)}</span>
                                            <xf:elseif is="$user.XBTUserStats.ratio < 0.5" />
                                                <span class="dataList-hint dataList-hint--bad">{$user.XBTUserStats.ratio|number(2)}</span>
                                            <xf:else />
                                                <span class="dataList-hint">{$user.XBTUserStats.ratio|number(2)}</span>
                                            </xf:if>
                                        <xf:else />
                                            <span class="dataList-hint">âˆž</span>
                                        </xf:if>
                                    </div>
                                </div>
                                <div class="dataList-cell dataList-cell--meta">
                                    <div class="dataList-mainRow">{$user.XBTUserStats.active_torrents}</div>
                                </div>
                                <div class="dataList-cell dataList-cell--meta">
                                    <div class="dataList-mainRow">{$user.XBTUserStats.bonus_points|number(0)}</div>
                                </div>
                                <div class="dataList-cell dataList-cell--action">
                                    <div class="buttonGroup buttonGroup--block">
                                        <a href="{{ link('tracker/users/edit', {'user_id': $user.user_id}) }}" 
                                           class="button button--link"
                                           data-xf-click="overlay">
                                            {{ phrase('edit') }}
                                        </a>
                                        <a href="{{ link('tracker/users/reset-passkey', {'user_id': $user.user_id}) }}" 
                                           class="button button--link"
                                           data-xf-click="overlay">
                                            {{ phrase('xbt_reset_passkey') }}
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </xf:foreach>
                    </div>
                </div>
            </xf:if>
        </div>
        
        <xf:pagenav page="{$page}" perpage="{$perPage}" total="{$total}" link="tracker/users" 
                   params="{'username': $username, 'ratio': $ratio, 'sort': $sort, 'order': $order}" />
    </div>
</div>

<div class="block">
    <div class="block-container">
        <div class="block-header">
            <h2 class="block-header-title">{{ phrase('xbt_tracker_statistics') }}</h2>
        </div>
        <div class="block-body">
            <div class="block-row">
                <div class="statsPairs">
                    <dl class="statsPair">
                        <dt>{{ phrase('xbt_total_users_with_passkeys') }}</dt>
                        <dd>{$trackerStats.users_with_passkeys}</dd>
                    </dl>
                    <dl class="statsPair">
                        <dt>{{ phrase('xbt_total_data_downloaded') }}</dt>
                        <dd>{$trackerStats.total_downloaded|file_size}</dd>
                    </dl>
                    <dl class="statsPair">
                        <dt>{{ phrase('xbt_total_data_uploaded') }}</dt>
                        <dd>{$trackerStats.total_uploaded|file_size}</dd>
                    </dl>
                    <dl class="statsPair">
                        <dt>{{ phrase('xbt_overall_ratio') }}</dt>
                        <dd>{$trackerStats.overall_ratio|number(2)}</dd>
                    </dl>
                    <dl class="statsPair">
                        <dt>{{ phrase('xbt_users_with_low_ratio') }}</dt>
                        <dd>{$trackerStats.users_with_low_ratio}</dd>
                    </dl>
                    <dl class="statsPair">
                        <dt>{{ phrase('xbt_users_with_warnings') }}</dt>
                        <dd>{$trackerStats.users_with_warnings}</dd>
                    </dl>
                </div>
            </div>
        </div>
    </div>
</div>