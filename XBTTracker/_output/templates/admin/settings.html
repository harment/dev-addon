{% extends "admin/base.html" %}

{% block title %}إعدادات النظام{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <h1 class="h3 mb-4">إعدادات النظام</h1>
    
    <div class="row">
        <div class="col-12 col-xl-3 col-md-4 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">الإعدادات</h5>
                </div>
                <div class="list-group list-group-flush" role="tablist">
                    <a class="list-group-item list-group-item-action active" data-bs-toggle="list" href="#general-settings" role="tab">
                        <i class="fas fa-cog me-2"></i> الإعدادات العامة
                    </a>
                    <a class="list-group-item list-group-item-action" data-bs-toggle="list" href="#tracker-settings" role="tab">
                        <i class="fas fa-server me-2"></i> إعدادات المتتبع
                    </a>
                    <a class="list-group-item list-group-item-action" data-bs-toggle="list" href="#tmdb-settings" role="tab">
                        <i class="fas fa-film me-2"></i> إعدادات TMDB
                    </a>
                    <a class="list-group-item list-group-item-action" data-bs-toggle="list" href="#bonus-settings" role="tab">
                        <i class="fas fa-gift me-2"></i> إعدادات المكافآت
                    </a>
                    <a class="list-group-item list-group-item-action" data-bs-toggle="list" href="#security-settings" role="tab">
                        <i class="fas fa-shield-alt me-2"></i> إعدادات الأمان
                    </a>
                    <a class="list-group-item list-group-item-action" data-bs-toggle="list" href="#mail-settings" role="tab">
                        <i class="fas fa-envelope me-2"></i> إعدادات البريد
                    </a>
                    <a class="list-group-item list-group-item-action" data-bs-toggle="list" href="#backup-settings" role="tab">
                        <i class="fas fa-hdd me-2"></i> النسخ الاحتياطي
                    </a>
                </div>
            </div>
        </div>
        
        <div class="col-12 col-xl-9 col-md-8">
            <div class="tab-content">
                <!-- الإعدادات العامة -->
                <div class="tab-pane fade show active" id="general-settings" role="tabpanel">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">الإعدادات العامة</h5>
                        </div>
                        <div class="card-body">
                            <form method="post" action="{{ url_for('admin.update_settings') }}">
                                <input type="hidden" name="section" value="general">
                                
                                <div class="mb-3">
                                    <label for="siteName" class="form-label">اسم الموقع</label>
                                    <input type="text" class="form-control" id="siteName" name="site_name" value="{{ settings.site_name }}">
                                </div>
                                
                                <div class="mb-3">
                                    <label for="siteDescription" class="form-label">وصف الموقع</label>
                                    <textarea class="form-control" id="siteDescription" name="site_description" rows="3">{{ settings.site_description }}</textarea>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="baseUrl" class="form-label">عنوان URL الأساسي</label>
                                    <input type="url" class="form-control" id="baseUrl" name="base_url" value="{{ settings.base_url }}">
                                </div>
                                
                                <div class="mb-3">
									<label for="adminEmail" class="form-label">بريد المدير الإلكتروني</label>
                                    <input type="email" class="form-control" id="adminEmail" name="admin_email" value="{{ settings.admin_email }}">
                                </div>
                                
                                <div class="mb-3">
                                    <label for="language" class="form-label">اللغة الافتراضية</label>
                                    <select class="form-select" id="language" name="default_language">
                                        <option value="ar" {% if settings.default_language == 'ar' %}selected{% endif %}>العربية</option>
                                        <option value="en" {% if settings.default_language == 'en' %}selected{% endif %}>الإنجليزية</option>
                                        <option value="fr" {% if settings.default_language == 'fr' %}selected{% endif %}>الفرنسية</option>
                                    </select>
                                </div>
                                
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="enableRegistration" name="enable_registration" {% if settings.enable_registration %}checked{% endif %}>
                                    <label class="form-check-label" for="enableRegistration">السماح بالتسجيل</label>
                                </div>
                                
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="requireInvitation" name="require_invitation" {% if settings.require_invitation %}checked{% endif %}>
                                    <label class="form-check-label" for="requireInvitation">التسجيل بدعوة فقط</label>
                                </div>
                                
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="enableMaintenance" name="maintenance_mode" {% if settings.maintenance_mode %}checked{% endif %}>
                                    <label class="form-check-label" for="enableMaintenance">وضع الصيانة</label>
                                </div>
                                
                                <button type="submit" class="btn btn-primary">حفظ الإعدادات</button>
                            </form>
                        </div>
                    </div>
                </div>
                
                <!-- إعدادات المتتبع -->
                <div class="tab-pane fade" id="tracker-settings" role="tabpanel">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">إعدادات المتتبع</h5>
                        </div>
                        <div class="card-body">
                            <form method="post" action="{{ url_for('admin.update_settings') }}">
                                <input type="hidden" name="section" value="tracker">
                                
                                <div class="mb-3">
                                    <label for="announceUrl" class="form-label">عنوان الإعلان (Announce URL)</label>
                                    <input type="text" class="form-control" id="announceUrl" name="announce_url" value="{{ settings.announce_url }}">
                                    <div class="form-text">عنوان URL الذي سيتم استخدامه في ملفات التورنت للإعلان عن التتبع.</div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="trackerPort" class="form-label">منفذ المتتبع</label>
                                    <input type="number" class="form-control" id="trackerPort" name="tracker_port" value="{{ settings.tracker_port }}">
                                </div>
                                
                                <div class="mb-3">
                                    <label for="announceInterval" class="form-label">الفاصل الزمني للإعلان (بالثواني)</label>
                                    <input type="number" class="form-control" id="announceInterval" name="announce_interval" value="{{ settings.announce_interval }}">
                                    <div class="form-text">عدد الثواني بين طلبات الإعلان من العملاء.</div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="minAnnounceInterval" class="form-label">الحد الأدنى للفاصل الزمني للإعلان (بالثواني)</label>
                                    <input type="number" class="form-control" id="minAnnounceInterval" name="min_announce_interval" value="{{ settings.min_announce_interval }}">
                                </div>
                                
                                <div class="mb-3">
                                    <label for="peerTimeout" class="form-label">مهلة النظير (بالدقائق)</label>
                                    <input type="number" class="form-control" id="peerTimeout" name="peer_timeout" value="{{ settings.peer_timeout }}">
                                    <div class="form-text">الوقت الذي يعتبر بعده النظير غير نشط.</div>
                                </div>
                                
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="requireAuth" name="require_auth" {% if settings.require_auth %}checked{% endif %}>
                                    <label class="form-check-label" for="requireAuth">طلب المصادقة</label>
                                    <div class="form-text">يتطلب من العملاء توفير مصادقة للوصول إلى المتتبع.</div>
                                </div>
                                
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="allowScrape" name="allow_scrape" {% if settings.allow_scrape %}checked{% endif %}>
                                    <label class="form-check-label" for="allowScrape">السماح بالكشط (Scrape)</label>
                                </div>
                                
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="isPrivate" name="is_private" {% if settings.is_private %}checked{% endif %}>
                                    <label class="form-check-label" for="isPrivate">متتبع خاص</label>
                                    <div class="form-text">عند التمكين، سيتم تعيين علامة "خاص" في ملفات التورنت المنشأة.</div>
                                </div>
                                
                                <button type="submit" class="btn btn-primary">حفظ الإعدادات</button>
                            </form>
                        </div>
                    </div>
                </div>
                
                <!-- إعدادات TMDB -->
                <div class="tab-pane fade" id="tmdb-settings" role="tabpanel">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">إعدادات The Movie Database (TMDB)</h5>
                        </div>
                        <div class="card-body">
                            <form method="post" action="{{ url_for('admin.update_settings') }}">
                                <input type="hidden" name="section" value="tmdb">
                                
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle"></i> 
                                    قاعدة بيانات الأفلام (TMDB) تستخدم للحصول على معلومات تلقائية عن الأفلام والمسلسلات التلفزيونية.
                                    <a href="https://www.themoviedb.org/documentation/api" target="_blank">احصل على مفتاح API من هنا</a>.
                                </div>
                                
                                <div class="mb-3">
                                    <label for="tmdbApiKey" class="form-label">مفتاح TMDB API</label>
                                    <input type="text" class="form-control" id="tmdbApiKey" name="tmdb_api_key" value="{{ settings.tmdb_api_key }}">
                                </div>
                                
                                <div class="mb-3">
                                    <label for="tmdbLanguage" class="form-label">لغة TMDB الافتراضية</label>
                                    <select class="form-select" id="tmdbLanguage" name="tmdb_language">
                                        <option value="ar" {% if settings.tmdb_language == 'ar' %}selected{% endif %}>العربية</option>
                                        <option value="en" {% if settings.tmdb_language == 'en' %}selected{% endif %}>الإنجليزية</option>
                                        <option value="fr" {% if settings.tmdb_language == 'fr' %}selected{% endif %}>الفرنسية</option>
                                    </select>
                                </div>
                                
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="tmdbAutoFetch" name="tmdb_auto_fetch" {% if settings.tmdb_auto_fetch %}checked{% endif %}>
                                    <label class="form-check-label" for="tmdbAutoFetch">جلب معلومات تلقائياً عند رفع التورنت</label>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="tmdbCacheTime" class="form-label">مدة تخزين البيانات المؤقت (بالساعات)</label>
                                    <input type="number" class="form-control" id="tmdbCacheTime" name="tmdb_cache_time" value="{{ settings.tmdb_cache_time }}">
                                    <div class="form-text">المدة التي سيتم بعدها تحديث البيانات المخزنة مؤقتاً.</div>
                                </div>
                                
                                <div class="card mb-3">
                                    <div class="card-header">
                                        <h6 class="mb-0">اختبار اتصال TMDB</h6>
                                    </div>
                                    <div class="card-body">
                                        <p>اختبر مفتاح API الخاص بك للتأكد من أنه يعمل بشكل صحيح.</p>
                                        <button type="button" id="testTmdbButton" class="btn btn-info">اختبار الاتصال</button>
                                        <div id="tmdbTestResult" class="mt-3"></div>
                                    </div>
                                </div>
                                
                                <button type="submit" class="btn btn-primary">حفظ الإعدادات</button>
                            </form>
                        </div>
                    </div>
                </div>
                
                <!-- إعدادات المكافآت -->
                <div class="tab-pane fade" id="bonus-settings" role="tabpanel">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">إعدادات نظام نقاط المكافآت</h5>
                        </div>
                        <div class="card-body">
                            <form method="post" action="{{ url_for('admin.update_settings') }}">
                                <input type="hidden" name="section" value="bonus">
                                
                                <div class="mb-3">
                                    <label for="bonusEnabled" class="form-label">تفعيل نظام المكافآت</label>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="bonusEnabled" name="bonus_enabled" {% if settings.bonus_enabled %}checked{% endif %}>
                                        <label class="form-check-label" for="bonusEnabled">تفعيل</label>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="bonusPerHour" class="form-label">النقاط لكل ساعة سييد (لكل GB)</label>
                                    <input type="number" step="0.01" class="form-control" id="bonusPerHour" name="bonus_per_hour" value="{{ settings.bonus_per_hour }}">
                                    <div class="form-text">عدد النقاط التي يحصل عليها المستخدم لكل ساعة من عمل سييد لكل 1GB.</div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="bonusMultiplierRare" class="form-label">مضاعف التورنتات النادرة</label>
                                    <input type="number" step="0.1" class="form-control" id="bonusMultiplierRare" name="bonus_multiplier_rare" value="{{ settings.bonus_multiplier_rare }}">
                                    <div class="form-text">مضاعف للنقاط عندما يكون هناك عدد قليل من المتصلين (يطبق عندما يكون عدد المتصلين أقل من 5).</div>
                                </div>
                                
                                <div class="card mb-3">
                                    <div class="card-header">
                                        <h6 class="mb-0">أسعار استبدال المكافآت</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label for="bonusCostWarning" class="form-label">تكلفة إزالة تحذير</label>
                                            <input type="number" class="form-control" id="bonusCostWarning" name="bonus_cost_warning" value="{{ settings.bonus_cost_warning }}">
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="bonusCostUpload" class="form-label">تكلفة 1GB رفع</label>
                                            <input type="number" class="form-control" id="bonusCostUpload" name="bonus_cost_upload" value="{{ settings.bonus_cost_upload }}">
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="bonusCostVip" class="form-label">تكلفة حالة VIP (شهر)</label>
                                            <input type="number" class="form-control" id="bonusCostVip" name="bonus_cost_vip" value="{{ settings.bonus_cost_vip }}">
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="bonusCostTitle" class="form-label">تكلفة اللقب المخصص</label>
                                            <input type="number" class="form-control" id="bonusCostTitle" name="bonus_cost_title" value="{{ settings.bonus_cost_title }}">
                                        </div>
                                    </div>
                                </div>
                                
                                <button type="submit" class="btn btn-primary">حفظ الإعدادات</button>
                            </form>
                        </div>
                    </div>
                </div>
                
                <!-- إعدادات الأمان -->
                <div class="tab-pane fade" id="security-settings" role="tabpanel">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">إعدادات الأمان</h5>
                        </div>
                        <div class="card-body">
                            <form method="post" action="{{ url_for('admin.update_settings') }}">
                                <input type="hidden" name="section" value="security">
                                
                                <div class="mb-3">
                                    <label for="loginAttempts" class="form-label">الحد الأقصى لمحاولات تسجيل الدخول</label>
                                    <input type="number" class="form-control" id="loginAttempts" name="max_login_attempts" value="{{ settings.max_login_attempts }}">
                                </div>
                                
                                <div class="mb-3">
                                    <label for="lockoutTime" class="form-label">مدة حظر الحساب بعد فشل تسجيل الدخول (بالدقائق)</label>
                                    <input type="number" class="form-control" id="lockoutTime" name="account_lockout_time" value="{{ settings.account_lockout_time }}">
                                </div>
                                
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="enableCaptcha" name="enable_captcha" {% if settings.enable_captcha %}checked{% endif %}>
                                    <label class="form-check-label" for="enableCaptcha">تفعيل CAPTCHA في نماذج التسجيل وتسجيل الدخول</label>
                                </div>
                                
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="require2FA" name="require_2fa_for_staff" {% if settings.require_2fa_for_staff %}checked{% endif %}>
                                    <label class="form-check-label" for="require2FA">طلب المصادقة الثنائية للمديرين والمشرفين</label>
                                </div>
                                
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="secureHeaders" name="use_secure_headers" {% if settings.use_secure_headers %}checked{% endif %}>
                                    <label class="form-check-label" for="secureHeaders">استخدام رؤوس HTTP الآمنة</label>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="securityEmail" class="form-label">بريد إلكتروني للإشعارات الأمنية</label>
                                    <input type="email" class="form-control" id="securityEmail" name="security_email" value="{{ settings.security_email }}">
                                </div>
                                
                                <button type="submit" class="btn btn-primary">حفظ الإعدادات</button>
                            </form>
                        </div>
                    </div>
                </div>
                
                <!-- إعدادات البريد -->
                <div class="tab-pane fade" id="mail-settings" role="tabpanel">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">إعدادات البريد الإلكتروني</h5>
                        </div>
                        <div class="card-body">
                            <form method="post" action="{{ url_for('admin.update_settings') }}">
                                <input type="hidden" name="section" value="mail">
                                
                                <div class="mb-3">
                                    <label for="mailDriver" class="form-label">نوع خدمة البريد</label>
                                    <select class="form-select" id="mailDriver" name="mail_driver">
                                        <option value="smtp" {% if settings.mail_driver == 'smtp' %}selected{% endif %}>SMTP</option>
                                        <option value="sendmail" {% if settings.mail_driver == 'sendmail' %}selected{% endif %}>Sendmail</option>
                                        <option value="mailgun" {% if settings.mail_driver == 'mailgun' %}selected{% endif %}>Mailgun</option>
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="mailHost" class="form-label">خادم SMTP</label>
                                    <input type="text" class="form-control" id="mailHost" name="mail_host" value="{{ settings.mail_host }}">
                                </div>
                                
                                <div class="mb-3">
                                    <label for="mailPort" class="form-label">منفذ SMTP</label>
                                    <input type="number" class="form-control" id="mailPort" name="mail_port" value="{{ settings.mail_port }}">
                                </div>
                                
                                <div class="mb-3">
                                    <label for="mailUsername" class="form-label">اسم المستخدم</label>
                                    <input type="text" class="form-control" id="mailUsername" name="mail_username" value="{{ settings.mail_username }}">
                                </div>
                                
                                <div class="mb-3">
                                    <label for="mailPassword" class="form-label">كلمة المرور</label>
                                    <input type="password" class="form-control" id="mailPassword" name="mail_password" value="{{ settings.mail_password }}">
                                </div>
                                
                                <div class="mb-3">
                                    <label for="mailEncryption" class="form-label">التشفير</label>
                                    <select class="form-select" id="mailEncryption" name="mail_encryption">
                                        <option value="tls" {% if settings.mail_encryption == 'tls' %}selected{% endif %}>TLS</option>
                                        <option value="ssl" {% if settings.mail_encryption == 'ssl' %}selected{% endif %}>SSL</option>
                                        <option value="none" {% if settings.mail_encryption == 'none' %}selected{% endif %}>بدون تشفير</option>
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="mailFromAddress" class="form-label">عنوان المرسل</label>
                                    <input type="email" class="form-control" id="mailFromAddress" name="mail_from_address" value="{{ settings.mail_from_address }}">
                                </div>
                                
                                <div class="mb-3">
                                    <label for="mailFromName" class="form-label">اسم المرسل</label>
                                    <input type="text" class="form-control" id="mailFromName" name="mail_from_name" value="{{ settings.mail_from_name }}">
                                </div>
                                
                                <div class="card mb-3">
                                    <div class="card-header">
                                        <h6 class="mb-0">اختبار إعدادات البريد</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label for="testEmailAddress" class="form-label">عنوان بريد إلكتروني للاختبار</label>
                                            <input type="email" class="form-control" id="testEmailAddress" name="test_email">
                                        </div>
                                        <button type="button" id="testMailButton" class="btn btn-info">إرسال بريد اختبار</button>
                                        <div id="mailTestResult" class="mt-3"></div>
                                    </div>
                                </div>
                                
                                <button type="submit" class="btn btn-primary">حفظ الإعدادات</button>
                            </form>
                        </div>
                    </div>
                </div>
                
                <!-- إعدادات النسخ الاحتياطي -->
                <div class="tab-pane fade" id="backup-settings" role="tabpanel">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">إعدادات النسخ الاحتياطي</h5>
                        </div>
                        <div class="card-body">
                            <form method="post" action="{{ url_for('admin.update_settings') }}">
                                <input type="hidden" name="section" value="backup">
                                
                                <div class="mb-3">
                                    <label for="backupEnabled" class="form-label">تفعيل النسخ الاحتياطي التلقائي</label>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="backupEnabled" name="backup_enabled" {% if settings.backup_enabled %}checked{% endif %}>
                                        <label class="form-check-label" for="backupEnabled">تفعيل</label>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="backupFrequency" class="form-label">تكرار النسخ الاحتياطي</label>
                                    <select class="form-select" id="backupFrequency" name="backup_frequency">
                                        <option value="daily" {% if settings.backup_frequency == 'daily' %}selected{% endif %}>يومي</option>
                                        <option value="weekly" {% if settings.backup_frequency == 'weekly' %}selected{% endif %}>أسبوعي</option>
                                        <option value="monthly" {% if settings.backup_frequency == 'monthly' %}selected{% endif %}>شهري</option>
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="backupPath" class="form-label">مسار النسخ الاحتياطي</label>
                                    <input type="text" class="form-control" id="backupPath" name="backup_path" value="{{ settings.backup_path }}">
                                </div>
                                
                                <div class="mb-3">
                                    <label for="backupRetention" class="form-label">الاحتفاظ بالنسخ الاحتياطية (عدد الأيام)</label>
                                    <input type="number" class="form-control" id="backupRetention" name="backup_retention" value="{{ settings.backup_retention }}">
                                    <div class="form-text">سيتم حذف النسخ الاحتياطية الأقدم من هذا العدد من الأيام.</div>
                                </div>
                                
                                <div class="mb-3">
                                    <div class="d-grid gap-2">
                                        <button type="button" id="createBackupButton" class="btn btn-warning">إنشاء نسخة احتياطية الآن</button>
                                        <button type="button" id="restoreBackupButton" class="btn btn-danger">استعادة من نسخة احتياطية</button>
                                    </div>
                                </div>
                                
                                <button type="submit" class="btn btn-primary">حفظ الإعدادات</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% block scripts %}
<script>
document.addEventListener("DOMContentLoaded", function() {
    // اختبار اتصال TMDB
    document.getElementById('testTmdbButton').addEventListener('click', function() {
        const tmdbApiKey = document.getElementById('tmdbApiKey').value;
        const resultDiv = document.getElementById('tmdbTestResult');
        
        resultDiv.innerHTML = '<div class="alert alert-info">جارٍ اختبار الاتصال...</div>';
        
        fetch("{{ url_for('admin.test_tmdb_api') }}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                api_key: tmdbApiKey
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                resultDiv.innerHTML = '<div class="alert alert-success"><i class="fas fa-check-circle"></i> تم الاتصال بنجاح! ' + data.message + '</div>';
            } else {
                resultDiv.innerHTML = '<div class="alert alert-danger"><i class="fas fa-times-circle"></i> فشل الاتصال: ' + data.message + '</div>';
            }
        })
        .catch(error => {
            resultDiv.innerHTML = '<div class="alert alert-danger"><i class="fas fa-times-circle"></i> خطأ في الاتصال: ' + error + '</div>';
        });
    });
    
    // اختبار إعدادات البريد
    document.getElementById('testMailButton').addEventListener('click', function() {
        const testEmail = document.getElementById('testEmailAddress').value;
        const resultDiv = document.getElementById('mailTestResult');
        
        if (!testEmail) {
            resultDiv.innerHTML = '<div class="alert alert-warning">يرجى إدخال عنوان بريد إلكتروني للاختبار!</div>';
            return;
        }
        
        resultDiv.innerHTML = '<div class="alert alert-info">جارٍ إرسال بريد اختبار...</div>';
        
        // جمع كل بيانات إعدادات البريد من النموذج
        const mailData = {
            test_email: testEmail,
            mail_driver: document.getElementById('mailDriver').value,
            mail_host: document.getElementById('mailHost').value,
            mail_port: document.getElementById('mailPort').value,
            mail_username: document.getElementById('mailUsername').value,
            mail_password: document.getElementById('mailPassword').value,
            mail_encryption: document.getElementById('mailEncryption').value,
            mail_from_address: document.getElementById('mailFromAddress').value,
            mail_from_name: document.getElementById('mailFromName').value
        };
        
        fetch("{{ url_for('admin.test_mail_settings') }}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(mailData)
        })
        .then(response => response.json())
        {% extends "admin/base.html" %}

{% block title %}إعدادات النظام{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <h1 class="h3 mb-4">إعدادات النظام</h1>
    
    <div class="row">
        <div class="col-12 col-xl-3 col-md-4 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">الإعدادات</h5>
                </div>
                <div class="list-group list-group-flush" role="tablist">
                    <a class="list-group-item list-group-item-action active" data-bs-toggle="list" href="#general-settings" role="tab">
                        <i class="fas fa-cog me-2"></i> الإعدادات العامة
                    </a>
                    <a class="list-group-item list-group-item-action" data-bs-toggle="list" href="#tracker-settings" role="tab">
                        <i class="fas fa-server me-2"></i> إعدادات المتتبع
                    </a>
                    <a class="list-group-item list-group-item-action" data-bs-toggle="list" href="#tmdb-settings" role="tab">
                        <i class="fas fa-film me-2"></i> إعدادات TMDB
                    </a>
                    <a class="list-group-item list-group-item-action" data-bs-toggle="list" href="#bonus-settings" role="tab">
                        <i class="fas fa-gift me-2"></i> إعدادات المكافآت
                    </a>
                    <a class="list-group-item list-group-item-action" data-bs-toggle="list" href="#security-settings" role="tab">
                        <i class="fas fa-shield-alt me-2"></i> إعدادات الأمان
                    </a>
                    <a class="list-group-item list-group-item-action" data-bs-toggle="list" href="#mail-settings" role="tab">
                        <i class="fas fa-envelope me-2"></i> إعدادات البريد
                    </a>
                    <a class="list-group-item list-group-item-action" data-bs-toggle="list" href="#backup-settings" role="tab">
                        <i class="fas fa-hdd me-2"></i> النسخ الاحتياطي
                    </a>
                </div>
            </div>
        </div>
        
        <div class="col-12 col-xl-9 col-md-8">
            <div class="tab-content">
                <!-- الإعدادات العامة -->
                <div class="tab-pane fade show active" id="general-settings" role="tabpanel">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">الإعدادات العامة</h5>
                        </div>
                        <div class="card-body">
                            <form method="post" action="{{ url_for('admin.update_settings') }}">
                                <input type="hidden" name="section" value="general">
                                
                                <div class="mb-3">
                                    <label for="siteName" class="form-label">اسم الموقع</label>
                                    <input type="text" class="form-control" id="siteName" name="site_name" value="{{ settings.site_name }}">
                                </div>
                                
                                <div class="mb-3">
                                    <label for="siteDescription" class="form-label">وصف الموقع</label>
                                    <textarea class="form-control" id="siteDescription" name="site_description" rows="3">{{ settings.site_description }}</textarea>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="baseUrl" class="form-label">عنوان URL الأساسي</label>
                                    <input type="url" class="form-control" id="baseUrl" name="base_url" value="{{ settings.base_url }}">
                                </div>
                                
                                <div class="mb-3">
									<label for="adminEmail" class="form-label">بريد المدير الإلكتروني</label>
                                    <input type="email" class="form-control" id="adminEmail" name="admin_email" value="{{ settings.admin_email }}">
                                </div>
                                
                                <div class="mb-3">
                                    <label for="language" class="form-label">اللغة الافتراضية</label>
                                    <select class="form-select" id="language" name="default_language">
                                        <option value="ar" {% if settings.default_language == 'ar' %}selected{% endif %}>العربية</option>
                                        <option value="en" {% if settings.default_language == 'en' %}selected{% endif %}>الإنجليزية</option>
                                        <option value="fr" {% if settings.default_language == 'fr' %}selected{% endif %}>الفرنسية</option>
                                    </select>
                                </div>
                                
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="enableRegistration" name="enable_registration" {% if settings.enable_registration %}checked{% endif %}>
                                    <label class="form-check-label" for="enableRegistration">السماح بالتسجيل</label>
                                </div>
                                
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="requireInvitation" name="require_invitation" {% if settings.require_invitation %}checked{% endif %}>
                                    <label class="form-check-label" for="requireInvitation">التسجيل بدعوة فقط</label>
                                </div>
                                
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="enableMaintenance" name="maintenance_mode" {% if settings.maintenance_mode %}checked{% endif %}>
                                    <label class="form-check-label" for="enableMaintenance">وضع الصيانة</label>
                                </div>
                                
                                <button type="submit" class="btn btn-primary">حفظ الإعدادات</button>
                            </form>
                        </div>
                    </div>
                </div>
                
                <!-- إعدادات المتتبع -->
                <div class="tab-pane fade" id="tracker-settings" role="tabpanel">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">إعدادات المتتبع</h5>
                        </div>
                        <div class="card-body">
                            <form method="post" action="{{ url_for('admin.update_settings') }}">
                                <input type="hidden" name="section" value="tracker">
                                
                                <div class="mb-3">
                                    <label for="announceUrl" class="form-label">عنوان الإعلان (Announce URL)</label>
                                    <input type="text" class="form-control" id="announceUrl" name="announce_url" value="{{ settings.announce_url }}">
                                    <div class="form-text">عنوان URL الذي سيتم استخدامه في ملفات التورنت للإعلان عن التتبع.</div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="trackerPort" class="form-label">منفذ المتتبع</label>
                                    <input type="number" class="form-control" id="trackerPort" name="tracker_port" value="{{ settings.tracker_port }}">
                                </div>
                                
                                <div class="mb-3">
                                    <label for="announceInterval" class="form-label">الفاصل الزمني للإعلان (بالثواني)</label>
                                    <input type="number" class="form-control" id="announceInterval" name="announce_interval" value="{{ settings.announce_interval }}">
                                    <div class="form-text">عدد الثواني بين طلبات الإعلان من العملاء.</div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="minAnnounceInterval" class="form-label">الحد الأدنى للفاصل الزمني للإعلان (بالثواني)</label>
                                    <input type="number" class="form-control" id="minAnnounceInterval" name="min_announce_interval" value="{{ settings.min_announce_interval }}">
                                </div>
                                
                                <div class="mb-3">
                                    <label for="peerTimeout" class="form-label">مهلة النظير (بالدقائق)</label>
                                    <input type="number" class="form-control" id="peerTimeout" name="peer_timeout" value="{{ settings.peer_timeout }}">
                                    <div class="form-text">الوقت الذي يعتبر بعده النظير غير نشط.</div>
                                </div>
                                
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="requireAuth" name="require_auth" {% if settings.require_auth %}checked{% endif %}>
                                    <label class="form-check-label" for="requireAuth">طلب المصادقة</label>
                                    <div class="form-text">يتطلب من العملاء توفير مصادقة للوصول إلى المتتبع.</div>
                                </div>
                                
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="allowScrape" name="allow_scrape" {% if settings.allow_scrape %}checked{% endif %}>
                                    <label class="form-check-label" for="allowScrape">السماح بالكشط (Scrape)</label>
                                </div>
                                
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="isPrivate" name="is_private" {% if settings.is_private %}checked{% endif %}>
                                    <label class="form-check-label" for="isPrivate">متتبع خاص</label>
                                    <div class="form-text">عند التمكين، سيتم تعيين علامة "خاص" في ملفات التورنت المنشأة.</div>
                                </div>
                                
                                <button type="submit" class="btn btn-primary">حفظ الإعدادات</button>
                            </form>
                        </div>
                    </div>
                </div>
                
                <!-- إعدادات TMDB -->
                <div class="tab-pane fade" id="tmdb-settings" role="tabpanel">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">إعدادات The Movie Database (TMDB)</h5>
                        </div>
                        <div class="card-body">
                            <form method="post" action="{{ url_for('admin.update_settings') }}">
                                <input type="hidden" name="section" value="tmdb">
                                
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle"></i> 
                                    قاعدة بيانات الأفلام (TMDB) تستخدم للحصول على معلومات تلقائية عن الأفلام والمسلسلات التلفزيونية.
                                    <a href="https://www.themoviedb.org/documentation/api" target="_blank">احصل على مفتاح API من هنا</a>.
                                </div>
                                
                                <div class="mb-3">
                                    <label for="tmdbApiKey" class="form-label">مفتاح TMDB API</label>
                                    <input type="text" class="form-control" id="tmdbApiKey" name="tmdb_api_key" value="{{ settings.tmdb_api_key }}">
                                </div>
                                
                                <div class="mb-3">
                                    <label for="tmdbLanguage" class="form-label">لغة TMDB الافتراضية</label>
                                    <select class="form-select" id="tmdbLanguage" name="tmdb_language">
                                        <option value="ar" {% if settings.tmdb_language == 'ar' %}selected{% endif %}>العربية</option>
                                        <option value="en" {% if settings.tmdb_language == 'en' %}selected{% endif %}>الإنجليزية</option>
                                        <option value="fr" {% if settings.tmdb_language == 'fr' %}selected{% endif %}>الفرنسية</option>
                                    </select>
                                </div>
                                
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="tmdbAutoFetch" name="tmdb_auto_fetch" {% if settings.tmdb_auto_fetch %}checked{% endif %}>
                                    <label class="form-check-label" for="tmdbAutoFetch">جلب معلومات تلقائياً عند رفع التورنت</label>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="tmdbCacheTime" class="form-label">مدة تخزين البيانات المؤقت (بالساعات)</label>
                                    <input type="number" class="form-control" id="tmdbCacheTime" name="tmdb_cache_time" value="{{ settings.tmdb_cache_time }}">
                                    <div class="form-text">المدة التي سيتم بعدها تحديث البيانات المخزنة مؤقتاً.</div>
                                </div>
                                
                                <div class="card mb-3">
                                    <div class="card-header">
                                        <h6 class="mb-0">اختبار اتصال TMDB</h6>
                                    </div>
                                    <div class="card-body">
                                        <p>اختبر مفتاح API الخاص بك للتأكد من أنه يعمل بشكل صحيح.</p>
                                        <button type="button" id="testTmdbButton" class="btn btn-info">اختبار الاتصال</button>
                                        <div id="tmdbTestResult" class="mt-3"></div>
                                    </div>
                                </div>
                                
                                <button type="submit" class="btn btn-primary">حفظ الإعدادات</button>
                            </form>
                        </div>
                    </div>
                </div>
                
                <!-- إعدادات المكافآت -->
                <div class="tab-pane fade" id="bonus-settings" role="tabpanel">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">إعدادات نظام نقاط المكافآت</h5>
                        </div>
                        <div class="card-body">
                            <form method="post" action="{{ url_for('admin.update_settings') }}">
                                <input type="hidden" name="section" value="bonus">
                                
                                <div class="mb-3">
                                    <label for="bonusEnabled" class="form-label">تفعيل نظام المكافآت</label>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="bonusEnabled" name="bonus_enabled" {% if settings.bonus_enabled %}checked{% endif %}>
                                        <label class="form-check-label" for="bonusEnabled">تفعيل</label>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="bonusPerHour" class="form-label">النقاط لكل ساعة سييد (لكل GB)</label>
                                    <input type="number" step="0.01" class="form-control" id="bonusPerHour" name="bonus_per_hour" value="{{ settings.bonus_per_hour }}">
                                    <div class="form-text">عدد النقاط التي يحصل عليها المستخدم لكل ساعة من عمل سييد لكل 1GB.</div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="bonusMultiplierRare" class="form-label">مضاعف التورنتات النادرة</label>
                                    <input type="number" step="0.1" class="form-control" id="bonusMultiplierRare" name="bonus_multiplier_rare" value="{{ settings.bonus_multiplier_rare }}">
                                    <div class="form-text">مضاعف للنقاط عندما يكون هناك عدد قليل من المتصلين (يطبق عندما يكون عدد المتصلين أقل من 5).</div>
                                </div>
                                
                                <div class="card mb-3">
                                    <div class="card-header">
                                        <h6 class="mb-0">أسعار استبدال المكافآت</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label for="bonusCostWarning" class="form-label">تكلفة إزالة تحذير</label>
                                            <input type="number" class="form-control" id="bonusCostWarning" name="bonus_cost_warning" value="{{ settings.bonus_cost_warning }}">
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="bonusCostUpload" class="form-label">تكلفة 1GB رفع</label>
                                            <input type="number" class="form-control" id="bonusCostUpload" name="bonus_cost_upload" value="{{ settings.bonus_cost_upload }}">
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="bonusCostVip" class="form-label">تكلفة حالة VIP (شهر)</label>
                                            <input type="number" class="form-control" id="bonusCostVip" name="bonus_cost_vip" value="{{ settings.bonus_cost_vip }}">
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="bonusCostTitle" class="form-label">تكلفة اللقب المخصص</label>
                                            <input type="number" class="form-control" id="bonusCostTitle" name="bonus_cost_title" value="{{ settings.bonus_cost_title }}">
                                        </div>
                                    </div>
                                </div>
                                
                                <button type="submit" class="btn btn-primary">حفظ الإعدادات</button>
                            </form>
                        </div>
                    </div>
                </div>
                
                <!-- إعدادات الأمان -->
                <div class="tab-pane fade" id="security-settings" role="tabpanel">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">إعدادات الأمان</h5>
                        </div>
                        <div class="card-body">
                            <form method="post" action="{{ url_for('admin.update_settings') }}">
                                <input type="hidden" name="section" value="security">
                                
                                <div class="mb-3">
                                    <label for="loginAttempts" class="form-label">الحد الأقصى لمحاولات تسجيل الدخول</label>
                                    <input type="number" class="form-control" id="loginAttempts" name="max_login_attempts" value="{{ settings.max_login_attempts }}">
                                </div>
                                
                                <div class="mb-3">
                                    <label for="lockoutTime" class="form-label">مدة حظر الحساب بعد فشل تسجيل الدخول (بالدقائق)</label>
                                    <input type="number" class="form-control" id="lockoutTime" name="account_lockout_time" value="{{ settings.account_lockout_time }}">
                                </div>
                                
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="enableCaptcha" name="enable_captcha" {% if settings.enable_captcha %}checked{% endif %}>
                                    <label class="form-check-label" for="enableCaptcha">تفعيل CAPTCHA في نماذج التسجيل وتسجيل الدخول</label>
                                </div>
                                
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="require2FA" name="require_2fa_for_staff" {% if settings.require_2fa_for_staff %}checked{% endif %}>
                                    <label class="form-check-label" for="require2FA">طلب المصادقة الثنائية للمديرين والمشرفين</label>
                                </div>
                                
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="secureHeaders" name="use_secure_headers" {% if settings.use_secure_headers %}checked{% endif %}>
                                    <label class="form-check-label" for="secureHeaders">استخدام رؤوس HTTP الآمنة</label>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="securityEmail" class="form-label">بريد إلكتروني للإشعارات الأمنية</label>
                                    <input type="email" class="form-control" id="securityEmail" name="security_email" value="{{ settings.security_email }}">
                                </div>
                                
                                <button type="submit" class="btn btn-primary">حفظ الإعدادات</button>
                            </form>
                        </div>
                    </div>
                </div>
                
                <!-- إعدادات البريد -->
                <div class="tab-pane fade" id="mail-settings" role="tabpanel">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">إعدادات البريد الإلكتروني</h5>
                        </div>
                        <div class="card-body">
                            <form method="post" action="{{ url_for('admin.update_settings') }}">
                                <input type="hidden" name="section" value="mail">
                                
                                <div class="mb-3">
                                    <label for="mailDriver" class="form-label">نوع خدمة البريد</label>
                                    <select class="form-select" id="mailDriver" name="mail_driver">
                                        <option value="smtp" {% if settings.mail_driver == 'smtp' %}selected{% endif %}>SMTP</option>
                                        <option value="sendmail" {% if settings.mail_driver == 'sendmail' %}selected{% endif %}>Sendmail</option>
                                        <option value="mailgun" {% if settings.mail_driver == 'mailgun' %}selected{% endif %}>Mailgun</option>
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="mailHost" class="form-label">خادم SMTP</label>
                                    <input type="text" class="form-control" id="mailHost" name="mail_host" value="{{ settings.mail_host }}">
                                </div>
                                
                                <div class="mb-3">
                                    <label for="mailPort" class="form-label">منفذ SMTP</label>
                                    <input type="number" class="form-control" id="mailPort" name="mail_port" value="{{ settings.mail_port }}">
                                </div>
                                
                                <div class="mb-3">
                                    <label for="mailUsername" class="form-label">اسم المستخدم</label>
                                    <input type="text" class="form-control" id="mailUsername" name="mail_username" value="{{ settings.mail_username }}">
                                </div>
                                
                                <div class="mb-3">
                                    <label for="mailPassword" class="form-label">كلمة المرور</label>
                                    <input type="password" class="form-control" id="mailPassword" name="mail_password" value="{{ settings.mail_password }}">
                                </div>
                                
                                <div class="mb-3">
                                    <label for="mailEncryption" class="form-label">التشفير</label>
                                    <select class="form-select" id="mailEncryption" name="mail_encryption">
                                        <option value="tls" {% if settings.mail_encryption == 'tls' %}selected{% endif %}>TLS</option>
                                        <option value="ssl" {% if settings.mail_encryption == 'ssl' %}selected{% endif %}>SSL</option>
                                        <option value="none" {% if settings.mail_encryption == 'none' %}selected{% endif %}>بدون تشفير</option>
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="mailFromAddress" class="form-label">عنوان المرسل</label>
                                    <input type="email" class="form-control" id="mailFromAddress" name="mail_from_address" value="{{ settings.mail_from_address }}">
                                </div>
                                
                                <div class="mb-3">
                                    <label for="mailFromName" class="form-label">اسم المرسل</label>
                                    <input type="text" class="form-control" id="mailFromName" name="mail_from_name" value="{{ settings.mail_from_name }}">
                                </div>
                                
                                <div class="card mb-3">
                                    <div class="card-header">
                                        <h6 class="mb-0">اختبار إعدادات البريد</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label for="testEmailAddress" class="form-label">عنوان بريد إلكتروني للاختبار</label>
                                            <input type="email" class="form-control" id="testEmailAddress" name="test_email">
                                        </div>
                                        <button type="button" id="testMailButton" class="btn btn-info">إرسال بريد اختبار</button>
                                        <div id="mailTestResult" class="mt-3"></div>
                                    </div>
                                </div>
                                
                                <button type="submit" class="btn btn-primary">حفظ الإعدادات</button>
                            </form>
                        </div>
                    </div>
                </div>
                
                <!-- إعدادات النسخ الاحتياطي -->
                <div class="tab-pane fade" id="backup-settings" role="tabpanel">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">إعدادات النسخ الاحتياطي</h5>
                        </div>
                        <div class="card-body">
                            <form method="post" action="{{ url_for('admin.update_settings') }}">
                                <input type="hidden" name="section" value="backup">
                                
                                <div class="mb-3">
                                    <label for="backupEnabled" class="form-label">تفعيل النسخ الاحتياطي التلقائي</label>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="backupEnabled" name="backup_enabled" {% if settings.backup_enabled %}checked{% endif %}>
                                        <label class="form-check-label" for="backupEnabled">تفعيل</label>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="backupFrequency" class="form-label">تكرار النسخ الاحتياطي</label>
                                    <select class="form-select" id="backupFrequency" name="backup_frequency">
                                        <option value="daily" {% if settings.backup_frequency == 'daily' %}selected{% endif %}>يومي</option>
                                        <option value="weekly" {% if settings.backup_frequency == 'weekly' %}selected{% endif %}>أسبوعي</option>
                                        <option value="monthly" {% if settings.backup_frequency == 'monthly' %}selected{% endif %}>شهري</option>
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="backupPath" class="form-label">مسار النسخ الاحتياطي</label>
                                    <input type="text" class="form-control" id="backupPath" name="backup_path" value="{{ settings.backup_path }}">
                                </div>
                                
                                <div class="mb-3">
                                    <label for="backupRetention" class="form-label">الاحتفاظ بالنسخ الاحتياطية (عدد الأيام)</label>
                                    <input type="number" class="form-control" id="backupRetention" name="backup_retention" value="{{ settings.backup_retention }}">
                                    <div class="form-text">سيتم حذف النسخ الاحتياطية الأقدم من هذا العدد من الأيام.</div>
                                </div>
                                
                                <div class="mb-3">
                                    <div class="d-grid gap-2">
                                        <button type="button" id="createBackupButton" class="btn btn-warning">إنشاء نسخة احتياطية الآن</button>
                                        <button type="button" id="restoreBackupButton" class="btn btn-danger">استعادة من نسخة احتياطية</button>
                                    </div>
                                </div>
                                
                                <button type="submit" class="btn btn-primary">حفظ الإعدادات</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% block scripts %}
<script>
document.addEventListener("DOMContentLoaded", function() {
    // اختبار اتصال TMDB
    document.getElementById('testTmdbButton').addEventListener('click', function() {
        const tmdbApiKey = document.getElementById('tmdbApiKey').value;
        const resultDiv = document.getElementById('tmdbTestResult');
        
        resultDiv.innerHTML = '<div class="alert alert-info">جارٍ اختبار الاتصال...</div>';
        
        fetch("{{ url_for('admin.test_tmdb_api') }}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                api_key: tmdbApiKey
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                resultDiv.innerHTML = '<div class="alert alert-success"><i class="fas fa-check-circle"></i> تم إرسال البريد بنجاح!</div>';
            } else {
                resultDiv.innerHTML = '<div class="alert alert-danger"><i class="fas fa-times-circle"></i> فشل إرسال البريد: ' + data.message + '</div>';
            }
        })
        .catch(error => {
            resultDiv.innerHTML = '<div class="alert alert-danger"><i class="fas fa-times-circle"></i> خطأ في الاتصال: ' + error + '</div>';
        });
    });
    
    // إنشاء نسخة احتياطية
    document.getElementById('createBackupButton').addEventListener('click', function() {
        if (confirm('هل أنت متأكد من رغبتك في إنشاء نسخة احتياطية الآن؟')) {
            fetch("{{ url_for('admin.create_backup') }}", {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('تم إنشاء النسخة الاحتياطية بنجاح: ' + data.filename);
                } else {
                    alert('فشل إنشاء النسخة الاحتياطية: ' + data.message);
                }
            })
            .catch(error => {
                alert('خطأ: ' + error);
            });
        }
    });
    
    // استعادة من نسخة احتياطية
    document.getElementById('restoreBackupButton').addEventListener('click', function() {
        if (confirm('تحذير: ستؤدي استعادة النسخة الاحتياطية إلى استبدال جميع البيانات الحالية! هل أنت متأكد من المتابعة؟')) {
            window.location.href = "{{ url_for('admin.restore_backup') }}";
        }
    });
});
</script>
{% endblock %}
{% endblock %}
        .then(data => {
            if (data.success) {
                resultDiv.innerHTML = '<div class="alert alert-success"><i class="fas fa-check-circle"></i> تم الاتصال بنجاح! ' + data.message + '</div>';
            } else {
                resultDiv.innerHTML = '<div class="alert alert-danger"><i class="fas fa-times-circle"></i> فشل الاتصال: ' + data.message + '</div>';
            }
        })
        .catch(error => {
            resultDiv.innerHTML = '<div class="alert alert-danger"><i class="fas fa-times-circle"></i> خطأ في الاتصال: ' + error + '</div>';
        });
    });
    
    // اختبار إعدادات البريد
    document.getElementById('testMailButton').addEventListener('click', function() {
        const testEmail = document.getElementById('testEmailAddress').value;
        const resultDiv = document.getElementById('mailTestResult');
        
        if (!testEmail) {
            resultDiv.innerHTML = '<div class="alert alert-warning">يرجى إدخال عنوان بريد إلكتروني للاختبار!</div>';
            return;
        }
        
        resultDiv.innerHTML = '<div class="alert alert-info">جارٍ إرسال بريد اختبار...</div>';
        
        // جمع كل بيانات إعدادات البريد من النموذج
        const mailData = {
            test_email: testEmail,
            mail_driver: document.getElementById('mailDriver').value,
            mail_host: document.getElementById('mailHost').value,
            mail_port: document.getElementById('mailPort').value,
            mail_username: document.getElementById('mailUsername').value,
            mail_password: document.getElementById('mailPassword').value,
            mail_encryption: document.getElementById('mailEncryption').value,
            mail_from_address: document.getElementById('mailFromAddress').value,
            mail_from_name: document.getElementById('mailFromName').value
        };
        
        fetch("{{ url_for('admin.test_mail_settings') }}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(mailData)
        })
        .then(response => response.json())
        {% extends "admin/base.html" %}

{% block title %}إعدادات النظام{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <h1 class="h3 mb-4">إعدادات النظام</h1>
    
    <div class="row">
        <div class="col-12 col-xl-3 col-md-4 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">الإعدادات</h5>
                </div>
                <div class="list-group list-group-flush" role="tablist">
                    <a class="list-group-item list-group-item-action active" data-bs-toggle="list" href="#general-settings" role="tab">
                        <i class="fas fa-cog me-2"></i> الإعدادات العامة
                    </a>
                    <a class="list-group-item list-group-item-action" data-bs-toggle="list" href="#tracker-settings" role="tab">
                        <i class="fas fa-server me-2"></i> إعدادات المتتبع
                    </a>
                    <a class="list-group-item list-group-item-action" data-bs-toggle="list" href="#tmdb-settings" role="tab">
                        <i class="fas fa-film me-2"></i> إعدادات TMDB
                    </a>
                    <a class="list-group-item list-group-item-action" data-bs-toggle="list" href="#bonus-settings" role="tab">
                        <i class="fas fa-gift me-2"></i> إعدادات المكافآت
                    </a>
                    <a class="list-group-item list-group-item-action" data-bs-toggle="list" href="#security-settings" role="tab">
                        <i class="fas fa-shield-alt me-2"></i> إعدادات الأمان
                    </a>
                    <a class="list-group-item list-group-item-action" data-bs-toggle="list" href="#mail-settings" role="tab">
                        <i class="fas fa-envelope me-2"></i> إعدادات البريد
                    </a>
                    <a class="list-group-item list-group-item-action" data-bs-toggle="list" href="#backup-settings" role="tab">
                        <i class="fas fa-hdd me-2"></i> النسخ الاحتياطي
                    </a>
                </div>
            </div>
        </div>
        
        <div class="col-12 col-xl-9 col-md-8">
            <div class="tab-content">
                <!-- الإعدادات العامة -->
                <div class="tab-pane fade show active" id="general-settings" role="tabpanel">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">الإعدادات العامة</h5>
                        </div>
                        <div class="card-body">
                            <form method="post" action="{{ url_for('admin.update_settings') }}">
                                <input type="hidden" name="section" value="general">
                                
                                <div class="mb-3">
                                    <label for="siteName" class="form-label">اسم الموقع</label>
                                    <input type="text" class="form-control" id="siteName" name="site_name" value="{{ settings.site_name }}">
                                </div>
                                
                                <div class="mb-3">
                                    <label for="siteDescription" class="form-label">وصف الموقع</label>
                                    <textarea class="form-control" id="siteDescription" name="site_description" rows="3">{{ settings.site_description }}</textarea>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="baseUrl" class="form-label">عنوان URL الأساسي</label>
                                    <input type="url" class="form-control" id="baseUrl" name="base_url" value="{{ settings.base_url }}">
                                </div>
                                
                                <div class="mb-3">
                                    <label for="adminEmail" class="form-label">بريد المدير الإلكتروني</label>
                                    <input type="email" class="form-control" id="adminEmail" name